<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ARTE.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/styles-additions.css">
    <link rel="stylesheet" href="/admin/css/admin-styles.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="admin-sidebar-header">
                <h3>ARTE.</h3>
                <p>Admin Panel</p>
            </div>
            <div class="admin-sidebar-menu">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/dashboard.html">
                            <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/artworks.html">
                            <i class="fas fa-palette me-2"></i> Artworks
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/artists.html">
                            <i class="fas fa-user-tie me-2"></i> Artists
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/exhibitions.html">
                            <i class="fas fa-calendar-alt me-2"></i> Exhibitions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/products.html">
                            <i class="fas fa-shopping-bag me-2"></i> Products
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/orders.html">
                            <i class="fas fa-shopping-cart me-2"></i> Orders
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users.html">
                            <i class="fas fa-users me-2"></i> Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/blog.html">
                            <i class="fas fa-blog me-2"></i> Blog
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/settings.html">
                            <i class="fas fa-cog me-2"></i> Settings
                        </a>
                    </li>
                </ul>
            </div>
            <div class="admin-sidebar-footer">
                <a href="/index.html" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-home me-2"></i> Back to Site
                </a>
                <button id="logoutBtn" class="btn btn-outline-danger btn-sm mt-2">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="admin-main">
            <!-- Header -->
            <div class="admin-header">
                <div class="admin-header-left">
                    <button class="btn btn-link sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h4 class="mb-0">Dashboard</h4>
                </div>
                <div class="admin-header-right">
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle" type="button" id="adminUserDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> <span id="adminUserName">Admin</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminUserDropdown">
                            <li><a class="dropdown-item" href="/profile.html"><i class="fas fa-user me-2"></i>My Profile</a></li>
                            <li><a class="dropdown-item" href="/admin/settings.html"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item" id="headerLogoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</button></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Content -->
            <div class="admin-content">
                <!-- Stats Cards -->
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 mb-4">
                    <div class="col">
                        <div class="dashboard-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="dashboard-card-title">Total Artworks</div>
                                        <div class="dashboard-card-value" id="totalArtworks">0</div>
                                    </div>
                                    <div class="dashboard-card-icon">
                                        <i class="fas fa-palette"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="dashboard-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="dashboard-card-title">Total Artists</div>
                                        <div class="dashboard-card-value" id="totalArtists">0</div>
                                    </div>
                                    <div class="dashboard-card-icon">
                                        <i class="fas fa-user-tie"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="dashboard-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="dashboard-card-title">Total Orders</div>
                                        <div class="dashboard-card-value" id="totalOrders">0</div>
                                    </div>
                                    <div class="dashboard-card-icon">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="dashboard-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="dashboard-card-title">Total Users</div>
                                        <div class="dashboard-card-value" id="totalUsers">0</div>
                                    </div>
                                    <div class="dashboard-card-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Orders & Popular Artworks -->
                <div class="row mb-4">
                    <div class="col-lg-8 mb-4 mb-lg-0">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Recent Orders</h5>
                                <a href="/admin/orders.html" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Order ID</th>
                                                <th>Customer</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Total</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentOrdersTable">
                                            <tr>
                                                <td colspan="6" class="text-center">
                                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <span class="ms-2">Loading orders...</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Popular Artworks</h5>
                                <a href="/admin/artworks.html" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush" id="popularArtworksList">
                                    <li class="list-group-item text-center">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="ms-2">Loading artworks...</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Upcoming Exhibitions & Latest Users -->
                <div class="row">
                    <div class="col-lg-6 mb-4 mb-lg-0">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Upcoming Exhibitions</h5>
                                <a href="/admin/exhibitions.html" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush" id="upcomingExhibitionsList">
                                    <li class="list-group-item text-center">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="ms-2">Loading exhibitions...</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Latest Users</h5>
                                <a href="/admin/users.html" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush" id="latestUsersList">
                                    <li class="list-group-item text-center">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="ms-2">Loading users...</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - admin dashboard');
            
            // Check if user is logged in and is admin
            if (!isLoggedIn()) {
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                return;
            }
            
            const user = getCurrentUser();
            if (!user.isAdmin) {
                window.location.href = '/index.html';
                return;
            }
            
            // Set admin user name
            document.getElementById('adminUserName').textContent = user.firstName;
            
            // Sidebar toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    document.querySelector('.admin-layout').classList.toggle('sidebar-collapsed');
                });
            }
            
            // Logout buttons
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('headerLogoutBtn').addEventListener('click', logout);
            
            // Load dashboard data
            loadDashboardStats();
            loadRecentOrders();
            loadPopularArtworks();
            loadUpcomingExhibitions();
            loadLatestUsers();
        });
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                // Get token
                const token = localStorage.getItem('userToken');
                
                // Fetch dashboard stats
                const response = await fetch('/api/admin/dashboard/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Update stats
                    document.getElementById('totalArtworks').textContent = data.totalArtworks || 0;
                    document.getElementById('totalArtists').textContent = data.totalArtists || 0;
                    document.getElementById('totalOrders').textContent = data.totalOrders || 0;
                    document.getElementById('totalUsers').textContent = data.totalUsers || 0;
                } else {
                    console.error('Error loading dashboard stats:', data.error);
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        // Load recent orders
        async function loadRecentOrders() {
            try {
                // Get token
                const token = localStorage.getItem('userToken');
                
                // Fetch recent orders
                const response = await fetch('/api/admin/orders/recent', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const ordersTable = document.getElementById('recentOrdersTable');
                    
                    if (data.orders && data.orders.length > 0) {
                        // Clear loading
                        ordersTable.innerHTML = '';
                        
                        // Add orders to table
                        data.orders.forEach(order => {
                            const orderDate = new Date(order.createdAt).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>#${order.orderNumber}</td>
                                <td>${order.customer.firstName} ${order.customer.lastName}</td>
                                <td>${orderDate}</td>
                                <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
                                <td>$${order.total.toFixed(2)}</td>
                                <td>
                                    <a href="/admin/orders/edit.html?id=${order._id}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            `;
                            
                            ordersTable.appendChild(row);
                        });
                    } else {
                        // No orders
                        ordersTable.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">No recent orders found</td>
                            </tr>
                        `;
                    }
                } else {
                    console.error('Error loading recent orders:', data.error);
                    document.getElementById('recentOrdersTable').innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">Failed to load recent orders</td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading recent orders:', error);
                document.getElementById('recentOrdersTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">Failed to load recent orders</td>
                    </tr>
                `;
            }
        }
        
        // Load popular artworks
        async function loadPopularArtworks() {
            try {
                // Get token
                const token = localStorage.getItem('userToken');
                
                // Fetch popular artworks
                const response = await fetch('/api/admin/artworks/popular', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const artworksList = document.getElementById('popularArtworksList');
                    
                    if (data.artworks && data.artworks.length > 0) {
                        // Clear loading
                        artworksList.innerHTML = '';
                        
                        // Add artworks to list
                        data.artworks.forEach(artwork => {
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item';
                            listItem.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <img src="${artwork.imageUrl || '/placeholder.svg?height=40&width=40'}" alt="${artwork.title}" class="me-3" style="width: 40px; height: 40px; object-fit: cover;">
                                        <div>
                                            <h6 class="mb-0">${artwork.title}</h6>
                                            <small class="text-muted">${artwork.artist}</small>
                                        </div>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">${artwork.views} views</span>
                                </div>
                            `;
                            
                            artworksList.appendChild(listItem);
                        });
                    } else {
                        // No artworks
                        artworksList.innerHTML = `
                            <li class="list-group-item text-center">No popular artworks found</li>
                        `;
                    }
                } else {
                    console.error('Error loading popular artworks:', data.error);
                    document.getElementById('popularArtworksList').innerHTML = `
                        <li class="list-group-item text-center">Failed to load popular artworks</li>
                    `;
                }
            } catch (error) {
                console.error('Error loading popular artworks:', error);
                document.getElementById('popularArtworksList').innerHTML = `
                    <li class="list-group-item text-center">Failed to load popular artworks</li>
                `;
            }
        }
        
        // Load upcoming exhibitions
        async function loadUpcomingExhibitions() {
            try {
                // Get token
                const token = localStorage.getItem('userToken');
                
                // Fetch upcoming exhibitions
                const response = await fetch('/api/admin/exhibitions/upcoming', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const exhibitionsList = document.getElementById('upcomingExhibitionsList');
                    
                    if (data.exhibitions && data.exhibitions.length > 0) {
                        // Clear loading
                        exhibitionsList.innerHTML = '';
                        
                        // Add exhibitions to list
                        data.exhibitions.forEach(exhibition => {
                            const startDate = new Date(exhibition.startDate).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                            
                            const endDate = new Date(exhibition.endDate).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                            
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item';
                            listItem.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">${exhibition.title}</h6>
                                        <small class="text-muted">${startDate} - ${endDate}</small>
                                    </div>
                                    <a href="/admin/exhibitions/edit.html?id=${exhibition._id}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            `;
                            
                            exhibitionsList.appendChild(listItem);
                        });
                    } else {
                        // No exhibitions
                        exhibitionsList.innerHTML = `
                            <li class="list-group-item text-center">No upcoming exhibitions found</li>
                        `;
                    }
                } else {
                    console.error('Error loading upcoming exhibitions:', data.error);
                    document.getElementById('upcomingExhibitionsList').innerHTML = `
                        <li class="list-group-item text-center">Failed to load upcoming exhibitions</li>
                    `;
                }
            } catch (error) {
                console.error('Error loading upcoming exhibitions:', error);
                document.getElementById('upcomingExhibitionsList').innerHTML = `
                    <li class="list-group-item text-center">Failed to load upcoming exhibitions</li>
                `;
            }
        }
        
        // Load latest users
        async function loadLatestUsers() {
            try {
                // Get token
                const token = localStorage.getItem('userToken');
                
                // Fetch latest users
                const response = await fetch('/api/admin/users/latest', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const usersList = document.getElementById('latestUsersList');
                    
                    if (data.users && data.users.length > 0) {
                        // Clear loading
                        usersList.innerHTML = '';
                        
                        // Add users to list
                        data.users.forEach(user => {
                            const joinDate = new Date(user.createdAt).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                            
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item';
                            listItem.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3" style="width: 40px; height: 40px; background-color: #d2b48c; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                            ${user.firstName.charAt(0)}${user.lastName.charAt(0)}
                                        </div>
                                        <div>
                                            <h6 class="mb-0">${user.firstName} ${user.lastName}</h6>
                                            <small class="text-muted">${user.email}</small>
                                        </div>
                                    </div>
                                    <small class="text-muted">${joinDate}</small>
                                </div>
                            `;
                            
                            usersList.appendChild(listItem);
                        });
                    } else {
                        // No users
                        usersList.innerHTML = `
                            <li class="list-group-item text-center">No recent users found</li>
                        `;
                    }
                } else {
                    console.error('Error loading latest users:', data.error);
                    document.getElementById('latestUsersList').innerHTML = `
                        <li class="list-group-item text-center">Failed to load latest users</li>
                    `;
                }
            } catch (error) {
                console.error('Error loading latest users:', error);
                document.getElementById('latestUsersList').innerHTML = `
                    <li class="list-group-item text-center">Failed to load latest users</li>
                `;
            }
        }
        
        // Helper function to get status color
        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'pending':
                    return 'warning';
                case 'processing':
                    return 'info';
                case 'shipped':
                    return 'primary';
                case 'delivered':
                    return 'success';
                case 'cancelled':
                    return 'danger';
                default:
                    return 'secondary';
            }
        }
    </script>
</body>
</html>
