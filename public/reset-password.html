<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - ARTE.</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="styles-additions.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
      <div class="container">
          <a class="navbar-brand" href="index.html">ARTE.</a>
          
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
              <ul class="navbar-nav mx-auto">
                  <li class="nav-item">
                      <a class="nav-link" href="index.html">HOME</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="artworks.html">ARTWORKS</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="artists.html">ARTISTS</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="exhibitions.html">EXHIBITIONS</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="shop.html">SHOP</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="blog.html">BLOG</a>
                  </li>
              </ul>
              <div class="login-signup d-flex align-items-center">
                  <a href="login.html"><button class="btn btn-login me-2">Login</button></a>
                  <a href="signup.html"><button class="btn btn-signup">Sign Up</button></a>
              </div>
          </div>
      </div>
  </nav>

  <!-- Reset Password Section -->
  <section class="reset-password-section">
      <div class="container">
          <div class="row justify-content-center">
              <div class="col-md-8 col-lg-5">
                  <div class="reset-password-card">
                      <div class="reset-password-header">
                          <h2>Create New Password</h2>
                          <p>Enter your new password below</p>
                      </div>
                      
                      <!-- Alert for errors -->
                      <div class="alert alert-danger d-none" id="errorAlert" role="alert">
                          <i class="fas fa-exclamation-circle me-2"></i>
                          <span id="errorMessage"></span>
                      </div>
                      
                      <!-- Alert for invalid token -->
                      <div class="alert alert-warning d-none" id="invalidTokenAlert" role="alert">
                          <i class="fas fa-exclamation-triangle me-2"></i>
                          <p>The password reset link is invalid or has expired.</p>
                          <p>Please request a new password reset link.</p>
                          <a href="forgot-password.html" class="btn btn-sm btn-primary mt-2">Request New Link</a>
                      </div>
                      
                      <form id="resetPasswordForm" class="reset-password-form" novalidate>
                          <input type="hidden" id="resetToken">
                          
                          <div class="mb-3">
                              <label for="newPassword" class="form-label">New Password</label>
                              <div class="password-input-group">
                                  <input type="password" class="form-control" id="newPassword" required>
                                  <span class="password-toggle" id="newPasswordToggle">
                                      <i class="fa fa-eye-slash"></i>
                                  </span>
                              </div>
                              <div class="password-strength" id="newPasswordStrength"></div>
                              <div class="invalid-feedback">Password must be at least 6 characters.</div>
                          </div>
                          
                          <div class="mb-4">
                              <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                              <div class="password-input-group">
                                  <input type="password" class="form-control" id="confirmNewPassword" required>
                                  <span class="password-toggle" id="confirmNewPasswordToggle">
                                      <i class="fa fa-eye-slash"></i>
                                  </span>
                              </div>
                              <div class="invalid-feedback">Passwords do not match.</div>
                          </div>
                          
                          <div class="password-requirements mb-4">
                              <p class="mb-1" style="font-size: 0.9rem;">Password must contain:</p>
                              <ul class="ps-3 mb-0" style="font-size: 0.8rem;">
                                  <li id="req-length" class="text-danger">At least 6 characters</li>
                                  <li id="req-number" class="text-danger">At least one number</li>
                                  <li id="req-special" class="text-danger">At least one special character</li>
                              </ul>
                          </div>
                          
                          <button type="submit" class="btn btn-reset-submit w-100">Reset Password</button>
                          
                          <div class="back-to-login mt-3">
                              <a href="login.html"><i class="fas fa-arrow-left me-2"></i>Back to Login</a>
                          </div>
                      </form>
                  </div>
              </div>
          </div>
      </div>
  </section>

  <!-- Password Reset Success Modal -->
  <div class="modal fade" id="passwordResetSuccessModal" tabindex="-1" aria-labelledby="passwordResetSuccessModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="passwordResetSuccessModalLabel">Password Reset Successful</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <div class="text-center mb-4">
                      <i class="fas fa-check-circle success-icon"></i>
                  </div>
                  <p class="text-center">Your password has been successfully reset.</p>
                  <p class="text-center">You can now log in with your new password.</p>
              </div>
              <div class="modal-footer">
                  <a href="login.html" class="btn btn-primary">Go to Login</a>
              </div>
          </div>
      </div>
  </div>

  <!-- Toast container for notifications -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - reset password page');
        
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        // Check if token exists
        if (!token) {
            document.getElementById('invalidTokenAlert').classList.remove('d-none');
            document.getElementById('resetPasswordForm').classList.add('d-none');
            console.log('No token found in URL');
            return;
        }
        
        // Set token in hidden field
        document.getElementById('resetToken').value = token;
        
        // Password toggle functionality
        const newPasswordToggle = document.getElementById('newPasswordToggle');
        const confirmNewPasswordToggle = document.getElementById('confirmNewPasswordToggle');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        
        if (newPasswordToggle) {
            newPasswordToggle.addEventListener('click', function() {
                const type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                newPasswordInput.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }
        
        if (confirmNewPasswordToggle) {
            confirmNewPasswordToggle.addEventListener('click', function() {
                const type = confirmNewPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                confirmNewPasswordInput.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }
        
        // Password strength and requirements check
        if (newPasswordInput) {
            newPasswordInput.addEventListener('input', function() {
                const password = this.value;
                const strengthMeter = document.getElementById('newPasswordStrength');
                
                // Update password requirements
                document.getElementById('req-length').className = password.length >= 6 ? 'text-success' : 'text-danger';
                document.getElementById('req-number').className = /[0-9]/.test(password) ? 'text-success' : 'text-danger';
                document.getElementById('req-special').className = /[^a-zA-Z0-9]/.test(password) ? 'text-success' : 'text-danger';
                
                if (!password) {
                    strengthMeter.innerHTML = '';
                    return;
                }
                
                // Calculate password strength
                let strength = 0;
                
                // Length check
                if (password.length >= 8) strength += 1;
                
                // Contains lowercase
                if (/[a-z]/.test(password)) strength += 1;
                
                // Contains uppercase
                if (/[A-Z]/.test(password)) strength += 1;
                
                // Contains number
                if (/[0-9]/.test(password)) strength += 1;
                
                // Contains special character
                if (/[^a-zA-Z0-9]/.test(password)) strength += 1;
                
                // Update strength meter
                let strengthText = '';
                let strengthClass = '';
                
                switch (strength) {
                    case 0:
                    case 1:
                        strengthText = 'Weak';
                        strengthClass = 'text-danger';
                        break;
                    case 2:
                    case 3:
                        strengthText = 'Medium';
                        strengthClass = 'text-warning';
                        break;
                    case 4:
                    case 5:
                        strengthText = 'Strong';
                        strengthClass = 'text-success';
                        break;
                }
                
                strengthMeter.innerHTML = `<small class="${strengthClass}">${strengthText}</small>`;
            });
        }
        
        // Check password match
        if (confirmNewPasswordInput) {
            confirmNewPasswordInput.addEventListener('input', function() {
                const password = newPasswordInput.value;
                const confirmPassword = this.value;
                
                if (password && confirmPassword) {
                    if (password !== confirmPassword) {
                        this.classList.add('is-invalid');
                    } else {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    }
                }
            });
        }
        
        // Form validation
        const form = document.getElementById('resetPasswordForm');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('Reset password form submitted');
                
                // Reset previous validation
                form.classList.remove('was-validated');
                errorAlert.classList.add('d-none');
                
                // Get form values
                const token = document.getElementById('resetToken').value;
                const password = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                console.log('Reset password attempt with token:', token.substring(0, 5) + '...');
                
                // Basic validation
                let isValid = true;
                
                if (!password || password.length < 6) {
                    document.getElementById('newPassword').classList.add('is-invalid');
                    isValid = false;
                } else {
                    document.getElementById('newPassword').classList.remove('is-invalid');
                }
                
                if (password !== confirmPassword) {
                    document.getElementById('confirmNewPassword').classList.add('is-invalid');
                    isValid = false;
                } else {
                    document.getElementById('confirmNewPassword').classList.remove('is-invalid');
                }
                
                // Check password requirements
                if (!(/[0-9]/.test(password) && /[^a-zA-Z0-9]/.test(password))) {
                    errorMessage.textContent = 'Password must contain at least one number and one special character.';
                    errorAlert.classList.remove('d-none');
                    isValid = false;
                }
                
                if (!isValid) {
                    console.log('Form validation failed');
                    return;
                }
                
                // Submit form data to API
                try {
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Resetting...';
                    
                    console.log('Sending reset password request to API');
                    
                    const response = await fetch('/api/auth/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            token,
                            password
                        })
                    });
                    
                    console.log('API response status:', response.status);
                    const data = await response.json();
                    console.log('API response data:', data);
                    
                    if (response.ok) {
                        console.log('Password reset successful');
                        
                        // Success - show modal
                        const passwordResetSuccessModal = new bootstrap.Modal(document.getElementById('passwordResetSuccessModal'));
                        passwordResetSuccessModal.show();
                        
                        // Reset form
                        form.reset();
                    } else {
                        console.log('Password reset failed:', data.error);
                        
                        // Check if token is invalid
                        if (data.error.includes('Invalid') || data.error.includes('expired')) {
                            document.getElementById('invalidTokenAlert').classList.remove('d-none');
                            form.classList.add('d-none');
                        } else {
                            // Show error message
                            errorMessage.textContent = data.error || 'An error occurred. Please try again.';
                            errorAlert.classList.remove('d-none');
                        }
                    }
                } catch (error) {
                    console.error('Reset password error:', error);
                    errorMessage.textContent = 'An unexpected error occurred. Please try again later.';
                    errorAlert.classList.remove('d-none');
                } finally {
                    // Re-enable submit button
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Reset Password';
                }
            });
        }
    });
  </script>
</body>
</html>
